# 并行程序设计环境搭建

## 前言

推荐使用虚拟机搭建该环境，在linux系统下，很多依赖环境可以一键解决。使用虚拟机时，主要调整虚拟机的配置，将CPU核心数改为2~4，可以达到4~8线程同时工作的效果。为了避免重复配置C语言代码的开发环境，可以在windows中编写代码，将代码写好后在linux中进行编译即可。但要注意的是，由于windows和linux使用的C编译器并不完全相同，所以部分依赖库不共用，例如<time.h>只能在linux下使用，在windows中可以使用<windows.h>替代。mac系统可以直接安装linux系统进行配置，使用方法完全相同。

## g++、gcc

### Windows

windows中需要单独下载mingw（C编译器以及依赖环境），但如果大家已经下载了Devc++并且可以正常编写C代码，可以不用再次配置。

### Linux

linux系统中原生自带gcc和g++。如果安装的linux发行版没有安装，则可以通过下列指令进行安装。

```
sudo apt install gcc
sudo apt install g++
```

可以通过下述代码和指令检查是否安装成功

#### gcc

```c
#include <stdio.h>

int main(){
    printf("Hello world!");
}
```

将上述代码保存为`main.c`并在终端中输入

```
gcc main.c -o main
./main
```

`gcc`表示调用`gcc`编译器进行编译，`main.c`表示要进行编译的代码，`-o `表示编译生成`.out`可执行程序，`main`表示生成的可执行程序，在`linux`下没有后缀，`windows`中需要加上`.exe`，`./main`表示执行程序

![](.asset/1.png)

#### g++

```c++
#include <iostream>

using namespace std;

int main(){
    cout << "Hello world!" << endl;
}
```

将上述代码保存为`main.c`并在终端中输入

```
g++ main.c -o main
./main
```

用法与`gcc`一致，`g++`可以同时编译'C'和'C++'的代码。

![](.asset/2.png)

#### 交叉编译

在使用python时，我们经常使用`import`导入其他的文件，这与c语言中使用`#include <xxx.h>`效果是一致的，但在使用自己编写的`C`文件时，包括后续使用`openblas`时需要显式的告诉编译器这些被调用的文件在哪里（本质是让这些文件形成一个工程文件，类似于学习大数据时导入jar包等操作，因为我们并没有使用例如vs等集成开发环境，因此需要手动通过编译指令告诉编译器）。例如

```c
建立三个文件，并在相应文件中输入内容
// fun.h
void fun();

// fun.c
#include <stdio.h>
void fun(){
    printf("Hello world");
}

// main.c
#include "fun.h"
int main(){
    fun();
    return 0;
}
```

在之前学习数据结构使用C语言时应该接触过函数声明的概念，C/C++要求使用的函数需要统一进行声明。之前编写单文件时，我们的声明都放在了代码最开始的位置，但在使用多文件时，源文件中的函数声明要放在与之同名的`.h`中，称之为头文件，并在需要调用的文件中加入`#include "fun.h"`，这个地方要注意，要使用双引号而不是尖括号，否则会报错。

编写完文件后在终端中输入

```
gcc main.c fun.c -o main
./main
```

![](.asset/3.png)

## make

刚才的示例中我们只用到了`main.c`和`fun.c`，但在实际的使用中，源文件、头文件以及主函数可能要多达数十个，每次编译都输入编译指令是非常麻烦的，可以`make`工具，`make`的功能可以理解为一个脚本，我们将需要执行的指令放在名为`makefile`或`Makefile`的文件中（文件名必须为两者之一，没有文件后缀），进行编译时，只需要在终端中输入`make`即可完成编译（需要在文件所在文件夹内）。

首先先安装`make`，linux系统中一般会自带，如没有，可通过如下指令下载

```
sudo apt install make
```

编写makefile

```makefile
all:
	gcc main.c fun.c -o main
```

在终端中输入`make`

![](.asset/4.png)

## cmake

在刚才的`make`工具的使用中，成功的进行了多文件编译，但是存在两个问题，一个是不会写`makefile`文件，另一个是在linux和windows中编译指令并不完全相同，因此代码的移植性太差，`cmake`可以解决这两个问题，但同样需要编写`CMakeList.txt`，这个文件的编写方法要比`makefile`简单忆一些。另外在C语言附加依赖库，例如后续使用的`OpenBLAS`时，同样需要使用`cmake`进行编译。

首先安装`cmake`，在终端中输入

```
sudo apt install cmake
```

感觉这门课中并不需要自己编写`CMakeList.txt`，所以有兴趣的同学可以自己学一下（劝退警告！！！）

## OpenBLAS

首先，浏览器中登录`https://github.com/xianyi/OpenBLAS`，将代码下载至本地（在windows或linux中下载代码均可，老师提供的方法需要在电脑中安装git工具），在本地将压缩包解压后，将整个文件夹移动到linux中。

在该文件夹中新建一个文件夹

在终端中打开该新建的文件夹并输入指令

```
cmake ..
```

![](.asset/5.png)

此时在该文件夹中已经生成`makefile`文件，直接输入`make -j12`即可完成`OpenBLAS`的安装（安装时间会非常长）

上述方法是老师提供的方式 通过看github上的README文档，感觉应该是芯片架构的问题，我使用的是ARM架构的芯片，所以安装总是出错，貌似X86架构芯片在虚拟机上编译也会报错，如果报错可以使用下面这种方式

```
首先安装gfortran编译器
sudo apt-get install gfortran

在OpenBLAS目录下开启终端，输入
sudo make FC=gfortran

经过一个漫长的编译时间之后（大概需要半个小时），输入
sudo make install

最后，建立软链接方面编译指令
ln -s /opt/OpenBLAS/lib/libopenblas.so.0   /usr/lib/libopenblas.so.0
```

可以使用如下代码进行测试

```c
#include <stdio.h>
#include <stdlib.h>
#include "cblas.h"

int main(){

        int n;                          /*! array size */
        double da;                      /*! double constant */
        double *dx;                     /*! input double array */
        int incx;                        /*! input stride */
        double *dy;                      /*! output double array */
        int incy;                       /*! output stride */

        int i;

        n = 10;
        da = 10;
        dx = (double*)malloc(sizeof(double)*n);
        incx = 1;
        dy = (double*)malloc(sizeof(double)*n);
        incy = 1;

        for(i=0;i<n;i++){
                dx[i] = 9-i;
                dy[i] = i;
                printf("%f ",dy[i]);    //输出原来的dy
        }
        printf("\n");

        cblas_daxpy(n, da, dx,incx, dy, incy);  //运行daxpy程序
    //    cblas_dcopy(n, dx,incx, dy, incy);      //运行dcopy程序

        for(i=0;i<n;i++){
            printf("%f ",dy[i]);   //输出计算后的dy
        }
        printf("\n");

        return 0;   
}  
```

编译指令如下

```
gcc main.c  -I /opt/OpenBLAS/include/ -L/opt/OpenBLAS/lib -lopenblas main
./main
```

![](.asset/6.png)

## git

关于git建议大家在本机上使用，因为我们在虚拟机中没有下载集成开发环境，因此修改代码等工作在本机中进行会比较方便，同时在本机使用git直接进行拉取和推送也比较容易，本机推荐使用VScode进行开发，可以直接链接GitHub。

另外，我会建立一个代码仓库，存放课程相关的代码和一些笔记文档，如果大家想参考或者共同维护仓库的话，可以私信我GitHub的账户名，我来拉取权限。

## Latex

关于latex，如果不想配置复杂的环境，可以直接使用老师提供的网页版编辑器，但本地的功能支持会更好，下载方式也非常简单，只需要搜索texlive镜像源下载即可，安装方式网上也有很多，不过也推荐爱折腾的同学使用vscode进行编写。